#!/bin/sh
# postinst script for tracks
#
# see: dh_installdeb(1)

[ -n "${DEBUG}" ] && set -x
set -e

. /usr/share/debconf/confmodule

LOGFILE='/var/log/openacalendar_install.log'
HOME=/usr/share/openacalendar

# if this script aborts with an error dpkg can hang if a debconf can
# hang if daemons have been started
trap db_stop EXIT

# Add the "tracks" user and group
getent group openacalendar >/dev/null || groupadd -r openacalendar
getent passwd openacalendar >/dev/null || \
    useradd -r -g openacalendar -d /usr/share/openacalendar -s /usr/sbin/nologin -c "OpenACalendar" openacalendar

chown -Rf openacalendar:openacalendar '/var/lib/openacalendar'
chown -Rf openacalendar:openacalendar '/var/cache/openacalendar'
chmod 755 '/var/lib/openacalendar'
chmod 755 '/var/cache/openacalendar'

# Ensure the psql login is in config.pp
# ...

# Do db stuff here once the postgresql config is in place
# cd $HOME && php core/cli/upgradeDatabase.php
# cd $HOME && php core/cli/loadStaticData.php

# test for and potentially add admin and slug
# cd $HOME && php core/cli/createUser.php USERNAME EMAIL PASSWORD sysadmin
# cd $HOME && php core/cli/createSite.php SLUG EMAIL

# Own all the core files
chown -Rf openacalendar:openacalendar $HOME

#DEBHELPER#

exit 0
